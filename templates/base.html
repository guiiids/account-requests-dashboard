<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Overview{% endblock %} | iLab Accounts</title>

    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Phosphor Icons (Phosphor is cleaner/modern standard) -->
    <script src="https://unpkg.com/@phosphor-icons/web@2.0.3"></script>

    <!-- App Design System -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        agilent: {
                            blue: '#0085D5',
                            dark: '#0B3F63',
                            light: '#E6F3FA'
                        },
                        surface: {
                            50: '#f8fafc',
                            100: '#f1f5f9',
                            200: '#e2e8f0',
                            300: '#cbd5e1',
                            400: '#94a3b8',
                            500: '#64748b',
                            600: '#475569',
                            700: '#334155',
                            800: '#1e293b',
                            900: '#0f172a',
                        }
                    }
                }
            }
        }
    </script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
    {% block extra_css %}{% endblock %}
</head>

<body>
    {% if current_user %}
    <div class="app-layout">
        <!-- SIDEBAR -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="brand-wrapper">
                    <!-- Agilent/iLab Brand Placeholder -->
                    <i class="ph-fill ph-flask brand-icon"></i>
                    <span>iLab Support</span>
                </div>
            </div>

            <nav class="sidebar-nav">
                <a href="{{ url_for('dashboard') }}"
                    class="nav-item {% if request.endpoint == 'dashboard' %}active{% endif %}">
                    <i class="ph ph-squares-four"></i>
                    <span>Overview</span>
                </a>
                <a href="{{ url_for('import_request') }}"
                    class="nav-item {% if request.endpoint == 'import_request' %}active{% endif %}">
                    <i class="ph ph-file-arrow-up"></i>
                    <span>Import Data</span>
                </a>

                {% if current_user.role == 'admin' %}
                <a href="{{ url_for('audit_log_viewer') }}"
                    class="nav-item {% if request.endpoint == 'audit_log_viewer' %}active{% endif %}">
                    <i class="ph ph-shield-check"></i>
                    <span>Audit Log</span>
                </a>

                <a href="{{ url_for('manage_users') }}"
                    class="nav-item {% if request.endpoint == 'manage_users' %}active{% endif %}">
                    <i class="ph ph-users"></i>
                    <span>Users</span>
                </a>
                <a href="#" class="nav-item disabled" style="opacity: 0.5;">
                    <i class="ph ph-chart-bar"></i>
                    <span>Reports</span>
                </a>
                {% endif %}
            </nav>

            <div class="sidebar-footer">
                <div class="user-snippet">
                    <div class="avatar-circle">
                        {{ current_user.name[:1].upper() }}
                    </div>
                    <div class="user-info">
                        <span class="user-name">{{ current_user.name }}</span>
                        <span class="user-role">{{ current_user.role|capitalize }}</span>
                    </div>
                    <a href="#" onclick="event.preventDefault(); document.getElementById('pw-modal-overlay').classList.add('active');"
                       class="logout-btn" title="Change Password" style="margin-right: -0.25rem;">
                        <i class="ph ph-lock-simple"></i>
                    </a>
                    <a href="{{ url_for('logout') }}" class="logout-btn" title="Sign Out">
                        <i class="ph ph-sign-out"></i>
                    </a>
                </div>
            </div>
        </aside>

        <!-- Change Password Modal -->
        <div id="pw-modal-overlay" class="modal-overlay" onclick="if(event.target===this) this.classList.remove('active');">
            <div class="modal" style="max-width: 420px;">
                <div class="modal-header">
                    <h3 style="font-size: 1.1rem; font-weight: 600; display: flex; align-items: center; gap: 0.5rem;">
                        <i class="ph ph-lock-simple"></i> Change Password
                    </h3>
                    <button onclick="document.getElementById('pw-modal-overlay').classList.remove('active');"
                            style="background:none;border:none;cursor:pointer;font-size:1.25rem;color:#9ca3af;">
                        <i class="ph ph-x"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div id="pw-change-error" style="display:none; background:#fef2f2; color:#dc2626; padding:0.75rem 1rem; border-radius:8px; font-size:0.875rem; margin-bottom:1rem; align-items:center; gap:0.5rem;">
                        <i class="ph ph-warning-circle"></i>
                        <span id="pw-change-error-text"></span>
                    </div>
                    <div id="pw-change-success" style="display:none; background:#f0fdf4; color:#16a34a; padding:0.75rem 1rem; border-radius:8px; font-size:0.875rem; margin-bottom:1rem; align-items:center; gap:0.5rem;">
                        <i class="ph ph-check-circle"></i>
                        <span>Password changed successfully!</span>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Current Password</label>
                        <input type="password" id="pw-current" class="form-input" placeholder="Enter current password">
                    </div>
                    <div class="form-group">
                        <label class="form-label">New Password</label>
                        <input type="password" id="pw-new" class="form-input" placeholder="Minimum 8 characters">
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label class="form-label">Confirm New Password</label>
                        <input type="password" id="pw-confirm" class="form-input" placeholder="Repeat new password">
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="document.getElementById('pw-modal-overlay').classList.remove('active');">Cancel</button>
                    <button class="btn btn-primary" onclick="submitPasswordChange()">Update Password</button>
                </div>
            </div>
        </div>

        <!-- MAIN CONTENT -->
        <main class="main-content">
            <!-- Top Sticky Header -->
            <header class="top-header">
                <div class="page-title">{% block page_title %}Dashboard{% endblock %}</div>
                <div class="header-actions">
                    <!-- Global Search could go here -->
                </div>
            </header>

            <div class="page-container">
                <!-- Flash Messages -->
                {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                {% for category, message in messages %}
                <div class="alert alert-{{ category }}">
                    {{ message }}
                </div>
                {% endfor %}
                {% endif %}
                {% endwith %}

                {% block content %}{% endblock %}
            </div>
        </main>
    </div>
    {% else %}
    <!-- No Sidebar for Login Page -->
    <main class="auth-layout">
        {% block auth_content %}{% endblock %}
    </main>
    {% endif %}

    {% block extra_js %}{% endblock %}

    <script>
    function submitPasswordChange() {
        const current = document.getElementById('pw-current').value;
        const newPw = document.getElementById('pw-new').value;
        const confirm = document.getElementById('pw-confirm').value;
        const errBox = document.getElementById('pw-change-error');
        const errText = document.getElementById('pw-change-error-text');
        const succBox = document.getElementById('pw-change-success');

        errBox.style.display = 'none';
        succBox.style.display = 'none';

        if (!current || !newPw || !confirm) {
            errText.textContent = 'All fields are required.';
            errBox.style.display = 'flex';
            return;
        }
        if (newPw.length < 8) {
            errText.textContent = 'New password must be at least 8 characters.';
            errBox.style.display = 'flex';
            return;
        }
        if (newPw !== confirm) {
            errText.textContent = 'New passwords do not match.';
            errBox.style.display = 'flex';
            return;
        }

        fetch('/other/api/change-password', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ current_password: current, new_password: newPw })
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                succBox.style.display = 'flex';
                document.getElementById('pw-current').value = '';
                document.getElementById('pw-new').value = '';
                document.getElementById('pw-confirm').value = '';
                setTimeout(() => {
                    document.getElementById('pw-modal-overlay').classList.remove('active');
                    succBox.style.display = 'none';
                }, 1500);
            } else {
                errText.textContent = data.error || 'Failed to change password.';
                errBox.style.display = 'flex';
            }
        })
        .catch(() => {
            errText.textContent = 'Network error. Please try again.';
            errBox.style.display = 'flex';
        });
    }
    </script>

    <!-- Convert UTC timestamps to each user's local browser timezone -->
    <script>
    function convertLocalTimes(root) {
        const container = root || document;
        container.querySelectorAll('time.local-time[data-utc]').forEach(el => {
            try {
                const utc = new Date(el.dataset.utc);
                if (isNaN(utc)) return;

                // Date-only values (midnight UTC) â†’ show date only
                if (utc.getUTCHours() === 0 && utc.getUTCMinutes() === 0 && utc.getUTCSeconds() === 0) {
                    el.textContent = utc.toLocaleDateString(undefined, {
                        year: 'numeric', month: 'short', day: 'numeric'
                    });
                } else {
                    // Full date + time in user's local timezone
                    const datePart = utc.toLocaleDateString(undefined, {
                        year: 'numeric', month: 'short', day: 'numeric'
                    });
                    const timePart = utc.toLocaleTimeString(undefined, {
                        hour: 'numeric', minute: '2-digit', hour12: true
                    });
                    el.textContent = `${datePart} at ${timePart}`;
                }
                // Mark as converted so we don't re-process
                el.removeAttribute('data-utc');
            } catch (e) { /* keep server fallback */ }
        });
    }
    document.addEventListener('DOMContentLoaded', () => convertLocalTimes());
    </script>
</body>

</html>